apiVersion: v1
kind: ConfigMap
metadata:
  name: create-buckets
data:
  main.tf: |
    terraform {
      required_providers {
        minio = {
          source  = "aminueza/minio"
          version = "~> 3.0"
        }
        aws = {
          source  = "hashicorp/aws"
          version = "~> 5.0"
        }
      }

      backend "s3" {
        bucket = "tf-state"
        key = "internal-buckets.tfstate"
        
        profile = "minio"

        skip_credentials_validation = true
        skip_metadata_api_check = true
        skip_region_validation = true
        use_path_style = true
      }

      required_version = ">= 1.0"
    }

    provider "minio" {
      minio_insecure = true
    }

    provider "aws" {
      region = "us-east-1"
    }

    resource "minio_s3_bucket" "models" {
      bucket = "models"
    }

    resource "minio_s3_bucket" "datasets" {
      bucket = "datasets"
    }

    {%- if cookiecutter.rbac %}

    resource "minio_iam_user" "ray_worker" {
      name = "rayworker"
    }

    resource "minio_accesskey" "ray_worker" {
      user = minio_iam_user.ray_worker.name
    }

    resource "aws_secretsmanager_secret" "ray_worker" {
      name = "minio/ray-worker-credentials"
    }

    resource "aws_secretsmanager_secret_version" "ray_worker" {
      secret_id     = aws_secretsmanager_secret.ray_worker.id
      secret_string = jsonencode({
        access_key = minio_accesskey.ray_worker.access_key
        secret_key = minio_accesskey.ray_worker.secret_key
      })
    }
    
    data "minio_iam_policy_document" "read_datasets" {
      statement {
        sid     = "AllowListDatasetsBucket"
        effect  = "Allow"
        actions = ["s3:ListBucket"]
        resources = ["arn:aws:s3:::datasets"]
      }

      statement {
        sid     = "AllowReadFromDatasets"
        effect  = "Allow"
        actions = [
          "s3:GetObject",
          "s3:GetObjectVersion"
        ]
        resources = ["arn:aws:s3:::datasets/*"]
      }
    }

    data "minio_iam_policy_document" "write_models" {
      statement {
        sid     = "AllowListDatasetsBucket"
        effect  = "Allow"
        actions = ["s3:ListBucket"]
        resources = ["arn:aws:s3:::models"]
      }

      statement {
        sid     = "AllowWriteToModels"
        effect  = "Allow"
        actions = [
          "s3:PutObject",
        ]
        resources = ["arn:aws:s3:::datasets/*"]
      }
    }

    resource "minio_iam_policy" "read_datasets" {
      name   = "read-datasets"
      policy = data.minio_iam_policy_document.read_datasets.json
    }

    resource "minio_iam_policy" "write_models" {
      name   = "write-models"
      policy = data.minio_iam_policy_document.write_models.json
    }

    resource "minio_iam_user_policy_attachment" "ray_worker_read_datasets" {
      user_name   = minio_iam_user.ray_worker.id
      policy_name = minio_iam_policy.read_datasets.id
    }

    resource "minio_iam_user_policy_attachment" "ray_worker_write_models" {
      user_name   = minio_iam_user.ray_worker.id
      policy_name = minio_iam_policy.write_models.id
    }
    {%- endif %}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: internal-buckets
spec:
  template:
    spec:
      initContainers:
        - name: prepare-minio
          image: localhost:5001/job:{% raw %}{{ .Values.environment }}{% endraw %}
          imagePullPolicy: Always
          {% if cookiecutter.honeypot %}
          tty: true  # Required for `mc admin service restart` command to work
          {% endif %}
          command: ["/bin/bash", "-c"]
          args: 
            - |
              # Configure MinIO client
              mc alias set myminio $MINIO_ENDPOINT $MINIO_ACCESS_KEY $MINIO_SECRET_KEY

              # Create state bucket if it doesn't exist
              mc mb myminio/tf-state --ignore-existing

              {%- if cookiecutter.honeypot %}

              # Setup webhook for notifications
              mc admin config set myminio notify_webhook:1 endpoint={% raw %}{{ .Values.honeypotWebhookUrl }}{% endraw %}

              # Restart MinIO (needed to apply config change)
              mc admin service restart myminio
              {% endif %}
          args:
            - |
              mc config host add myminio http://$MINIO_ENDPOINT $MINIO_USER $MINIO_PASSWORD
          env:
            - name: MINIO_USER
              value: "minioadmin"
            - name: MINIO_PASSWORD
              value: "minioadmin"
            - name: MINIO_ENDPOINT
              value: "minio.minio-internal-{% raw %}{{ .Values.environment }}{% endraw %}.svc.cluster.local:9000"
      containers:
        - name: create-internal-buckets
          image: ghcr.io/opentofu/opentofu:latest
          imagePullPolicy: Always
          command: ["/bin/sh", "-c"]
          args:
            - |
              mkdir -p ~/.aws && \
              cat > ~/.aws/config <<EOF
              [minio]
              aws_access_key_id = ${MINIO_USER}
              aws_secret_access_key = ${MINIO_PASSWORD}
              region = us-east-1
              endpoint_url = http://${MINIO_ENDPOINT}
              EOF
              cd /workspace && \
              tofu init && \
              tofu apply -auto-approve
          env:
            - name: MINIO_USER
              value: "minioadmin"
            - name: MINIO_PASSWORD
              value: "minioadmin"
            - name: MINIO_ENDPOINT
              value: "minio.minio-internal-{% raw %}{{ .Values.environment }}{% endraw %}.svc.cluster.local:9000"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: access-key
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: secret-access-key
            - name: AWS_ENDPOINT_URL
              value: "http://aws-proxy.proxy.svc.cluster.local"
          volumeMounts:
            - name: tofu-workspace
              mountPath: /workspace
            - name: tofu-source
              mountPath: /workspace/main.tf
              subPath: main.tf
      restartPolicy: Never
      volumes:
        - name: tofu-source
          configMap:
            name: create-buckets
        - name: tofu-workspace
          emptyDir: {}
        - name: model-volume
          hostPath:
            path: /volumes/huggingface/models/model-small
            type: Directory
        - name: dataset-volume
          hostPath:
            path: /volumes/huggingface/datasets/imdb
            type: Directory
  backoffLimit: 4
  activeDeadlineSeconds: 300
---
{%- if cookiecutter.honeypot %}
apiVersion: batch/v1
kind: Job
metadata:
  name: internal-buckets
spec:
  template:
    spec:
      containers:
        - name: create-honeypot-file
          image: ghcr.io/opentofu/opentofu:latest
          imagePullPolicy: Always
          command: ["/bin/sh", "-c"]
          args:
            - |
              # Create honeypot file
              echo '{"aws_key": "AKIA0EXAMPLEEXAMPLE", "aws_secret": "examplesecrethoneypotvaluedonotuse12345"}' > /tmp/aws-credentials.json
              
              # Place honeypot file in strategic location
              mc mb myminio/models/.credentials --ignore-existing
              mc cp /tmp/aws-credentials.json myminio/models/.credentials/aws-credentials.json
              
              # Create a fake team-confidential folder
              mc mb myminio/datasets/team-confidential --ignore-existing
              echo '{"customer_data": "sample"}' > /tmp/customer-data.json
              mc cp /tmp/customer-data.json myminio/datasets/team-confidential/customer-data.json
              
              # Configure event notifications for honeypot files
              mc event add myminio/models/.credentials arn:minio:sqs::1:webhook --event get,put,delete --ignore-existing
              mc event add myminio/datasets/team-confidential arn:minio:sqs::1:webhook --event get,put,delete --ignore-existing

              {%- endif %}
          env:
            - name: MINIO_ACCESS_KEY
              value: "minioadmin"
            - name: MINIO_SECRET_KEY
              value: "minioadmin"
          volumeMounts:
            - name: dataset-volume
              mountPath: /volumes/imdb
              readOnly: true
            - name: model-volume
              mountPath: /volumes/model-small
              readOnly: true
      restartPolicy: Never
      volumes:
        - name: tofu-source
          configMap:
            name: create-buckets
        - name: tofu-workspace
          emptyDir: {}
        - name: model-volume
          hostPath:
            path: /volumes/huggingface/models/model-small
            type: Directory
        - name: dataset-volume
          hostPath:
            path: /volumes/huggingface/datasets/imdb
            type: Directory
  backoffLimit: 4
  activeDeadlineSeconds: 300
---
{%- if cookiecutter.network_policies %}
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: create-buckets-job-policy
spec:
  endpointSelector:
    matchLabels:
      job-name: create-buckets
  egress:
    # Allow discovery and download of OpenTofu providers
    - toFQDNs:
        - matchPattern: "*.opentofu.org"
        - matchPattern: "github.com"
        - matchPattern: "*.github.com"
        - matchPattern: "*.githubusercontent.com"
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
    # Allow access to the internal MinIO instance
    - toEndpoints:
        - matchLabels:
            app: minio
            k8s:io.kubernetes.pod.namespace: minio-internal-{% raw %}{{ .Values.environment }}{% endraw %}
      toPorts:
        - ports:
            - port: "9000"
              protocol: TCP
    # Allow access to the AWS proxy
    - toEndpoints:
        - matchLabels:
            app: aws-proxy
            k8s:io.kubernetes.pod.namespace: proxy
      toPorts:
        - ports:
            - port: "80"
              protocol: TCP
---
{%- endif %}

