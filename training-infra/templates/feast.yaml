apiVersion: batch/v1
kind: Job
metadata:
  name: feast
  namespace: feast-{{ .Values.environment }}
spec:
  template:
    spec:
      containers:
      - name: feast-setup
        image: python:3.12-slim
        imagePullPolicy: Always
        command:
        - /bin/bash
        - -c
        - |
          pip install feast
          feast init feast
          cd feast/feature_repo
          feast apply
{{/*        env:*/}}
{{/*        - name: REDIS_PASSWORD*/}}
{{/*          valueFrom:*/}}
{{/*            secretKeyRef:*/}}
{{/*              name: redis-{{ .Values.environment }}*/}}
{{/*              key: redis-password*/}}
{{/*        - name: ENVIRONMENT*/}}
{{/*          value: {{ .Values.environment }}*/}}
      restartPolicy: Never
  backoffLimit: 4
  activeDeadlineSeconds: 600  # Job will fail after 600 seconds if not completed
{{/*---*/}}
{{/*apiVersion: "cilium.io/v2"*/}}
{{/*kind: CiliumNetworkPolicy*/}}
{{/*metadata:*/}}
{{/*  name: feast-network-policy*/}}
{{/*  namespace: feast-{{ .Values.environment }}*/}}
{{/*spec:*/}}
{{/*  endpointSelector:*/}}
{{/*    matchLabels:*/}}
{{/*      job-name: feast-{{ .Values.environment }}*/}}
{{/*  egress:*/}}
{{/*    # Allow access to Redis*/}}
{{/*    - toEndpoints:*/}}
{{/*        - matchLabels:*/}}
{{/*            app: feast-redis*/}}
{{/*            k8s:io.kubernetes.pod.namespace: feast-redis-{{ .Values.environment }}*/}}
{{/*      toPorts:*/}}
{{/*        - ports:*/}}
{{/*            - port: "6379"*/}}
{{/*              protocol: TCP*/}}
{{/*    */}}
{{/*    # Allow DNS queries*/}}
{{/*    - toEndpoints:*/}}
{{/*        - matchLabels:*/}}
{{/*            k8s:io.kubernetes.pod.namespace: kube-system*/}}
{{/*            k8s-app: kube-dns*/}}
{{/*      toPorts:*/}}
{{/*        - ports:*/}}
{{/*            - port: "53"*/}}
{{/*              protocol: UDP*/}}
{{/*            - port: "53"*/}}
{{/*              protocol: TCP*/}}
{{/*              */}}
